<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - adaptors/persistent.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/es-analysis/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>adaptors/persistent.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">73.71</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">204</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">33.42</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">1.30</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">/*jslint node: true */
&quot;use strict&quot;;

var async           = require(&quot;async&quot;)
    , _             = require(&quot;lodash&quot;)
    , commons       = require(&quot;./../commons&quot;)
    , utils         = require(&quot;./../utils&quot;)
    , batchelor     = require(&quot;./../batchelor&quot;)
    , Runner        = require(&quot;./../commons/runner&quot;)
    , separator     = &quot;_&quot;
    , runner
    , log
    , config;


/**
 * check if the response was changed, currently using JSON.stringify
 * @param _previous - object of previous request
 * @param _current object of current request
 * @returns {boolean} - true is changed, false otherwise
 */
function _isResponseChanged(previous, current) {
    return JSON.stringify(previous) !== JSON.stringify(current);
}

/**
 * run the given method, if its a function type
 * @param callback - method to call
 * @param err - error to pass in callback
 * @param result - result to pass in callback
 * @private
 */
function _runCallback(callback, err, result) {
    if (typeof callback === &quot;function&quot;) {
        log.info(&quot;[Persistent Adaptor] calling given callback&quot;);

        try {
            callback(err, result);
        }
        catch (e) {
            log.error(&quot;[Persistent Adaptor], exception when calling given method e: &quot; + e);
        }
    }
    else {
        log.info(&quot;[Persistent Adaptor] not a valid callback&quot;);
    }

}

/**
 * method for taking care of a single persistent request
 * it will run the callback for the given request only if the response from the current response and previous is different
 * @param err
 * @param result
 * @param persistentReq
 * @private
 */
function _processSingleItem (item) {
    var currTime = Date.now()
        , delta = currTime - item.firedTime
        , name = item.name
        , callCallback = false;

    if (delta &gt;= item.persistentDelay) {
        item.firedTime = currTime;
        item.bodyTemp = item.bodyTemp || {};
        batchelor.execute(item, function (err, result) {

            // TODO[omher]: HOW TO REAL CHECK IF THERE IS CHANGED, WITH BODY ?????
            if (item.ignoreResponse || (!commons.helper.isEmptyObject(result) &amp;&amp; result[name] &amp;&amp; result[name].body &amp;&amp; _isResponseChanged(result[name].body, item.bodyTemp))) {
                item.bodyTemp = result[name].body;
                _runCallback(item.callback, err, result);
            }

        });
    }
}

function _startPersist () {
    setImmediate(runner.start(0, false,
        function (err, item) {
            _processSingleItem(item);
        },
        function () {
            setTimeout(function () {
                _startPersist();
            }, 0);
        }));

}

function _persist () {
    _startPersist();
}

/**
 * callback to be called once the batchelor finish processing the job
 * @param err - error passed from batchelor
 * @param result - result passed from batchelor
 * @param persistentJob - job to process again and again until its stopped
 * @private
 */
function _batchelorCallbackFirstRun(err, result, reqs) {
    var delays = [], minTime;

    log.error(&quot;[Persistent Adaptor] _batchelorCallbackFirstRun called with  err: &quot; + err);

    _.forEach(reqs, function (cReq) {
        var name = cReq.name;

        if (utils.validator.isPersistentRequest(cReq)) {
            delays.push(cReq.persistentDelay || 2000);
        }

        _runCallback(cReq.callback, err, result[name]);
    });

    // take the minimum timeout - the minimum is the one we will use in the timeout
    minTime = Math.min.apply(Math, delays);

    setTimeout(function () {
        _persist();
    }, minTime);

}

/**
 * process job calling to &quot;batchelor.execute&quot; and waiting for callback to be called from batchelor
 * @param _persistentJob
 * @private
 */
function _process(allowReqs) {
    log.info(&quot;[Persistent Adaptor] _process calling batchelor.execute ...&quot;);

    batchelor.execute(allowReqs, function(err, result) {
        _batchelorCallbackFirstRun(err, result, allowReqs);

    });
}


/**
 * set the adaptor configuration + configure batchelor
 * @param cfg - configuration object for the adaptor and batchelor
 * @returns {*} - batchelor configuration
 */
exports.configure = function (cfg) {
    config = commons.helper.configure(cfg);
    log = config.logger || console;
    return batchelor.configure(cfg);
};

/**
 * entry point of the persistent object
 * @param job - object containing one or more requests
 * @param callback - method to call once the batchelor finish processing job
 * @returns {*} - job id - string
 */
exports.execute = function (job, callback) {
    log.info(&quot;[Persistent Adaptor] execute for job: &quot; + JSON.stringify(job));
    var allowReqs = [];
    var reqs = commons.helper.convert2Array(job);
    var jobId = commons.helper.getUniqueId(&quot;jobName&quot; + separator);

    _.forEach(reqs, function (cReq) {

        cReq.callback = cReq.callback || callback;

        if (utils.validator.isPersistentRequest(cReq) &amp;&amp; utils.validator.isValidRequest(cReq)) {
            cReq.jobId = jobId;
            cReq.firedTime = Date.now();
            cReq.ignoreResponse = cReq.ignoreResponse || false;
            allowReqs.push(cReq);
        }
        else {
            log.error(&quot;[Persistent Adaptor] not a persistent request: &quot; + JSON.stringify(cReq));
        }
    });
    runner = new Runner(allowReqs);
    _process(reqs);

    return jobId;

};

/**
 * method to stop running job, if exist
 * @param jobId - job to stop
 * @returns {boolean}
 */
exports.stop = function (jobId, reqId) {
    log.info(&quot;[Persistent Adaptor] stopping jobId : &quot; + jobId + &quot; request Id: &quot; + reqId);
    var runnerProp = runner.getProperties();
    runnerProp.array = runnerProp.array || [];
    var indexOf = _.findIndex(runnerProp.array, { &#039;name&#039;: reqId });

    if (indexOf &gt;= 0) {
        runner.stop();
        runner.removeItem(indexOf);
        runner.resume();
    }
    else {
        log.warn(&quot;[Persistent Adaptor] couldn&#039;t stop jobId : &quot; + jobId + &quot; request Id: &quot; + reqId + &quot; given values doesn&#039;t exist!&quot;);
    }
};</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
